#!/usr/bin/env sh

# Advanced pre-commit hook with comprehensive checks
# To use this, rename to 'pre-commit' and make executable

# Configuration - set these to control which checks run
CHECK_TRANSLATIONS=true
CHECK_TYPESCRIPT=true
CHECK_LINT=true
CHECK_BUILD=true
CHECK_FORMATTING=true
CHECK_SECURITY=false      # Set to true for security scanning
CHECK_IMPORTS=false       # Set to true for import analysis
CHECK_BUNDLE_SIZE=false   # Set to true for bundle analysis (requires build)

echo "ğŸš€ Running advanced pre-commit checks..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# 1. Translation validation (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚)
if [ "$CHECK_TRANSLATIONS" = true ]; then
  echo "ğŸŒ Validating translations..."
  npm run validate:translations
  
  if [ $? -ne 0 ]; then
    echo "âŒ Translation validation failed. Please fix missing translations before committing."
    echo "ğŸ’¡ Tip: Run 'npm run validate:translations' to see all missing translations"
    exit 1
  fi
  echo "âœ… Translation validation passed!"
  echo ""
fi

# 2. TypeScript type checking (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚)
if [ "$CHECK_TYPESCRIPT" = true ]; then
  echo "ğŸ”§ Running TypeScript type check..."
  npm run typecheck
  
  if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type check failed. Please fix type errors before committing."
    exit 1
  fi
  echo "âœ… TypeScript type check passed!"
  echo ""
fi

# 3. Security checks (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğµ)
if [ "$CHECK_SECURITY" = true ]; then
  echo "ğŸ”’ Running security checks..."
  npm run check:security
  
  if [ $? -ne 0 ]; then
    echo "âŒ High-priority security issues found. Please review and fix before committing."
    exit 1
  fi
  echo "âœ… Security check passed!"
  echo ""
fi

# 4. ESLint (Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ, Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚)
if [ "$CHECK_LINT" = true ]; then
  echo "ğŸ” Running ESLint..."
  npm run lint || echo "âš ï¸  Found ESLint warnings, but allowing commit to proceed"
  echo ""
fi

# 5. Prettier formatting check (Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ, Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚)
if [ "$CHECK_FORMATTING" = true ]; then
  if command -v npx >/dev/null 2>&1; then
    echo "ğŸ’… Checking code formatting..."
    npm run format:check || {
      echo "âš ï¸  Code formatting issues found. Consider running 'npm run format' to fix them."
      echo "ğŸ’¡ Tip: This is just a warning, commit will proceed"
    }
    echo ""
  fi
fi

# 6. Build check (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… ÑĞ±Ğ¾Ñ€ĞºĞ¸)
if [ "$CHECK_BUILD" = true ]; then
  echo "ğŸ—ï¸  Testing build process..."
  npm run build
  
  if [ $? -ne 0 ]; then
    echo "âŒ Build failed. Please fix build errors before committing."
    exit 1
  fi
  echo "âœ… Build check passed!"
  echo ""
fi

# 7. Import analysis (Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ, Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚)
if [ "$CHECK_IMPORTS" = true ]; then
  echo "ğŸ”— Analyzing imports..."
  npm run check:imports || echo "ğŸ’¡ Consider reviewing import suggestions"
  echo ""
fi

# 8. Bundle size check (Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ, Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚)
if [ "$CHECK_BUNDLE_SIZE" = true ]; then
  echo "ğŸ“¦ Checking bundle size..."
  npm run check:bundle || echo "ğŸ’¡ Consider reviewing bundle size"
  echo ""
fi

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ‰ All critical checks passed! Ready to commit."
echo ""
echo "ğŸ“Š Commit Summary:"
echo "   âœ… Translations: validated"
echo "   âœ… TypeScript: type-safe"
echo "   âœ… Build: successful"
[ "$CHECK_SECURITY" = true ] && echo "   ğŸ”’ Security: scanned"
[ "$CHECK_FORMATTING" = true ] && echo "   ğŸ’… Formatting: checked"
echo ""